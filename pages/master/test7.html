<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Column Chart with Filters</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts" />
    <style>
      #filters {
        margin-bottom: 20px;
      }
      #filters select,
      #filters button {
        margin-right: 10px;
      }
      #data-table {
        display: none;
      }
      .active {
        background-color: #007bff;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="filters">
      <select id="locationFilter1">
        <option value="">All Locations</option>
      </select>
      <button id="weeklyFilter1">Weekly</button>
      <button id="monthlyFilter1">Monthly</button>
    </div>
    <div id="chart1"></div>

    <table id="dataTable2">
      <thead>
        <tr>
          <th>Location</th>
          <th>Machine Number</th>
          <th>Printed</th>
          <th>Verified</th>
          <th>Total</th>
          <th>DateTime</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Location1</td>
          <td>001</td>
          <td>10</td>
          <td>5</td>
          <td>15</td>
          <td>2024-06-01T16:00:00Z</td>
        </tr>
        <tr>
          <td>Location2</td>
          <td>002</td>
          <td>20</td>
          <td>10</td>
          <td>30</td>
          <td>2024-06-02T16:00:00Z</td>
        </tr>
        <tr>
          <td>Location3</td>
          <td>003</td>
          <td>30</td>
          <td>15</td>
          <td>45</td>
          <td>2024-06-03T16:00:00Z</td>
        </tr>
        <tr>
          <td>Location1</td>
          <td>004</td>
          <td>40</td>
          <td>20</td>
          <td>60</td>
          <td>2024-06-04T16:00:00Z</td>
        </tr>
        <tr>
          <td>Location2</td>
          <td>005</td>
          <td>50</td>
          <td>25</td>
          <td>75</td>
          <td>2024-06-05T16:00:00Z</td>
        </tr>
        <tr>
          <td>Location3</td>
          <td>006</td>
          <td>60</td>
          <td>30</td>
          <td>90</td>
          <td>2024-06-06T16:00:00Z</td>
        </tr>
        <tr>
          <td>Location1</td>
          <td>007</td>
          <td>70</td>
          <td>35</td>
          <td>105</td>
          <td>2024-06-07T16:00:00Z</td>
        </tr>
      </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const dataTable2 = document.getElementById("dataTable2");
        let data1 = [];

        const parseTableData1 = () => {
          const rows1 = dataTable2.querySelectorAll("tbody tr");
          rows1.forEach((row) => {
            const cells = row.querySelectorAll("td");
            data1.push({
              location: cells[0].textContent,
              machineNumber: cells[1].textContent,
              printed: parseInt(cells[2].textContent),
              verified: parseInt(cells[3].textContent),
              total: parseInt(cells[4].textContent),
              dateTime: new Date(cells[5].textContent),
            });
          });
        };

        let filteredData1 = [];
        const locationFilter1 = document.getElementById("locationFilter1");
        const weeklyFilterButton1 = document.getElementById("weeklyFilter1");
        const monthlyFilterButton1 = document.getElementById("monthlyFilter1");

        const initializeLocationFilter1 = () => {
          const locations1 = [...new Set(data1.map((item) => item.location))];
          locations1.forEach((location) => {
            const option1 = document.createElement("option");
            option1.value = location;
            option1.textContent = location;
            locationFilter1.appendChild(option1);
          });
        };

        const filterData1 = () => {
          const selectedLocation1 = locationFilter1.value;
          const now1 = new Date();
          const startOfWeek1 = new Date();
          startOfWeek1.setDate(now1.getDate() - now1.getDay() + 1); // Start of the week (Monday)
          const endOfWeek1 = new Date(startOfWeek1);
          endOfWeek1.setDate(startOfWeek1.getDate() + 6); // End of the week (Sunday)
          const oneMonthAgo1 = new Date();
          oneMonthAgo1.setMonth(now1.getMonth() - 1);

          filteredData1 = data1.filter((item) => {
            const transactionDate1 = new Date(item.dateTime);
            if (selectedLocation1 && item.location !== selectedLocation1)
              return false;
            if (
              weeklyFilterButton1.classList.contains("active") &&
              (transactionDate1 < startOfWeek1 || transactionDate1 > endOfWeek1)
            )
              return false;
            if (
              monthlyFilterButton1.classList.contains("active") &&
              transactionDate1 < oneMonthAgo1
            )
              return false;
            return true;
          });

          updateChart1();
        };

        let chart1 = null;

        const updateChart1 = () => {
          const accumulatedTotal = Array(12).fill(0);
          const hourlySums = Array.from({ length: 12 }, () =>
            Array(24).fill(0)
          );

          filteredData1.forEach((item) => {
            const month1 = item.dateTime.getMonth();
            accumulatedTotal[month1] += item.total;

            const hour = item.dateTime.getHours();
            hourlySums[month1][hour] += item.total;
          });

          const averageBusiestHours = hourlySums.map((hourList) => {
            if (hourList.every((val) => val === 0)) return "N/A";
            const maxHour = hourList.indexOf(Math.max(...hourList));
            return `${maxHour}:00`;
          });

          const options1 = {
            series: [
              {
                name: "Accumulated Total",
                color: "#377DFF",
                data: accumulatedTotal,
              },
            ],
            chart: {
              type: "bar",
              height: 350,
            },
            plotOptions: {
              bar: {
                horizontal: false,
              },
            },
            xaxis: {
              categories: [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December",
              ],
            },
            tooltip: {
              y: {
                formatter: function (val, { dataPointIndex }) {
                  return `Total: ${val}, Busiest Hour: ${averageBusiestHours[dataPointIndex]}`;
                },
              },
            },
          };

          if (chart1) {
            chart1.destroy();
          }

          chart1 = new ApexCharts(document.querySelector("#chart1"), options1);
          chart1.render();
        };

        locationFilter1.addEventListener("change", filterData1);
        weeklyFilterButton1.addEventListener("click", () => {
          weeklyFilterButton1.classList.add("active");
          monthlyFilterButton1.classList.remove("active");
          filterData1();
        });
        monthlyFilterButton1.addEventListener("click", () => {
          monthlyFilterButton1.classList.add("active");
          weeklyFilterButton1.classList.remove("active");
          filterData1();
        });

        // Initial chart update
        parseTableData1();
        initializeLocationFilter1();
        weeklyFilterButton1.classList.add("active"); // Set default filter to weekly
        filterData1();
      });
    </script>
  </body>
</html>
