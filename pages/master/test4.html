<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Column Chart with Filters</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts">
  <style>
    #filters {
      margin-bottom: 20px;
    }
    #filters select, #filters button {
      margin-right: 10px;
    }
    #data-table {
      display: none;
    }
    .active {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <div id="filters">
    <select id="locationFilter">
      <option value="">All Locations</option>
    </select>
    <button id="weeklyFilter">Weekly</button>
    <button id="monthlyFilter">Monthly</button>
  </div>
  <div id="chart"></div>

  <table id="dataTable1">
    <thead>
      <tr>
        <th>Location</th>
        <th>Machine Number</th>
        <th>Printed</th>
        <th>Verified</th>
        <th>Total</th>
        <th>Transaction Date</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Location1</td>
        <td>001</td>
        <td>10</td>
        <td>5</td>
        <td>15</td>
        <td>2024-06-01</td>
      </tr>
      <tr>
        <td>Location2</td>
        <td>002</td>
        <td>20</td>
        <td>10</td>
        <td>30</td>
        <td>2024-06-02</td>
      </tr>
      <tr>
        <td>Location3</td>
        <td>003</td>
        <td>30</td>
        <td>15</td>
        <td>45</td>
        <td>2024-06-03</td>
      </tr>
      <tr>
        <td>Location1</td>
        <td>004</td>
        <td>40</td>
        <td>20</td>
        <td>60</td>
        <td>2024-06-04</td>
      </tr>
      <tr>
        <td>Location2</td>
        <td>005</td>
        <td>50</td>
        <td>25</td>
        <td>75</td>
        <td>2024-06-05</td>
      </tr>
      <tr>
        <td>Location3</td>
        <td>006</td>
        <td>60</td>
        <td>30</td>
        <td>90</td>
        <td>2024-06-06</td>
      </tr>
      <tr>
        <td>Location1</td>
        <td>007</td>
        <td>70</td>
        <td>35</td>
        <td>105</td>
        <td>2024-06-07</td>
      </tr>
    </tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const dataTable = document.getElementById("dataTable1");
      let data = [];

      const parseTableData = () => {
        const rows = dataTable.querySelectorAll("tbody tr");
        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          data.push({
            location: cells[0].textContent,
            machineNumber: cells[1].textContent,
            printed: parseInt(cells[2].textContent),
            verified: parseInt(cells[3].textContent),
            total: parseInt(cells[4].textContent),
            transactionDate: new Date(cells[5].textContent),
          });
        });
      };

      let filteredData = [];
      const locationFilter = document.getElementById("locationFilter");
      const weeklyFilterButton = document.getElementById("weeklyFilter");
      const monthlyFilterButton = document.getElementById("monthlyFilter");

      const initializeLocationFilter = () => {
        const locations = [...new Set(data.map((item) => item.location))];
        locations.forEach((location) => {
          const option = document.createElement("option");
          option.value = location;
          option.textContent = location;
          locationFilter.appendChild(option);
        });
      };

      const filterData = () => {
        const selectedLocation = locationFilter.value;
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay() + 1); // Start of the week (Monday)
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6); // End of the week (Sunday)
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(now.getMonth() - 1);

        filteredData = data.filter((item) => {
          const transactionDate = new Date(item.transactionDate);
          if (selectedLocation && item.location !== selectedLocation) return false;
          if (weeklyFilterButton.classList.contains("active") && (transactionDate < startOfWeek || transactionDate > endOfWeek)) return false;
          if (monthlyFilterButton.classList.contains("active") && transactionDate < oneMonthAgo) return false;
          return true;
        });

        updateChart();
      };

      let chart = null;

      const updateChart = () => {
        const printedCertificates = Array(12).fill(0);
        const verifiedTransaction = Array(12).fill(0);

        filteredData.forEach((item) => {
          const month = new Date(item.transactionDate).getMonth();
          printedCertificates[month] += item.printed;
          verifiedTransaction[month] += item.verified;
        });

        const options = {
          series: [
            {
              name: "Cetak Sertifikat",
              color: "#377DFF",
              data: printedCertificates,
            },
            {
              name: "Verifikasi Sentuh Tanahku",
              color: "#BF37FF",
              data: verifiedTransaction,
            },
          ],
          chart: {
            type: "bar",
            height: 350,
          },
          plotOptions: {
            bar: {
              horizontal: false,
            },
          },
          xaxis: {
            categories: [
              "January",
              "February",
              "March",
              "April",
              "May",
              "June",
              "July",
              "August",
              "September",
              "October",
              "November",
              "December",
            ],
          },
        };

        if (chart) {
          chart.destroy();
        }

        chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
      };

      locationFilter.addEventListener("change", filterData);
      weeklyFilterButton.addEventListener("click", () => {
        weeklyFilterButton.classList.add("active");
        monthlyFilterButton.classList.remove("active");
        filterData();
      });
      monthlyFilterButton.addEventListener("click", () => {
        monthlyFilterButton.classList.add("active");
        weeklyFilterButton.classList.remove("active");
        filterData();
      });

      // Initial chart update
      parseTableData();
      initializeLocationFilter();
      weeklyFilterButton.classList.add("active"); // Set default filter to weekly
      filterData();
    });
  </script>
</body>
</html>
